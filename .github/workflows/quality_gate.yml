name: Quality Gate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality_gate:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¯ Setup Dart
      uses: dart-lang/setup-dart@v1
      with:
        sdk: stable
        
    - name: ğŸ“¦ Install dependencies
      run: dart pub get
      
    - name: ğŸ” Run static analysis
      run: dart analyze --fatal-warnings
      
    - name: ğŸ¨ Check formatting
      run: dart format --output=none --set-exit-if-changed .
      
    - name: ğŸ§ª Run tests with coverage
      run: |
        dart test --coverage=coverage
        dart run coverage:format_coverage --lcov --in=coverage --out=coverage/lcov.info --packages=.dart_tool/package_config.json
        
    - name: ğŸ“Š Check coverage threshold
      run: dart run tool/coverage.dart
      
    - name: âš¡ Run performance benchmarks
      run: dart run tool/benchmark.dart
      
    - name: ğŸ“¦ Check package quality  
      run: dart run tool/package_quality.dart
      
    - name: âœ… Quality gate passed
      run: echo "ğŸ‰ All quality checks passed!"

  security_scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”’ Run security audit
      run: dart pub deps --json | dart analyze --packages

  dependency_check:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¯ Setup Dart
      uses: dart-lang/setup-dart@v1
      
    - name: ğŸ“¦ Check for outdated dependencies
      run: dart pub outdated --mode=null-safety
      
    - name: ğŸ” Validate pubspec
      run: dart pub publish --dry-run